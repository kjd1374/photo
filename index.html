<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Archive Final</title>
    <style>
        :root {
            --bg-color: #f4f4f9; --card-bg: #ffffff; --text-color: #333333; --accent-color: #007AFF;
        }
        body.dark-mode {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --accent-color: #4dabf7;
        }
        body { margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, sans-serif; transition: background 0.3s, color 0.3s; }
        
        /* í—¤ë” & ê²€ìƒ‰ */
        header { display: flex; justify-content: space-between; align-items: center; max-width: 1000px; margin: 0 auto 20px; padding: 0 10px; }
        h1 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        .controls { display: flex; gap: 10px; }
        .btn-icon { background: var(--card-bg); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; color: var(--text-color); transition: 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        .search-box { max-width: 1000px; margin: 0 auto 20px; padding: 0 10px; }
        #searchInput { width: 100%; padding: 12px 20px; border-radius: 25px; border: none; background: var(--card-bg); color: var(--text-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); font-size: 16px; outline: none; box-sizing: border-box; }

        /* ê°¤ëŸ¬ë¦¬ ê·¸ë¦¬ë“œ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; max-width: 1000px; margin: 0 auto; }
        .item { position: relative; border-radius: 12px; overflow: hidden; background: var(--card-bg); aspect-ratio: 1 / 1; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .item:hover { transform: translateY(-3px); }
        .item img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
        .video-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        #loadMoreBtn { display: block; margin: 30px auto; padding: 10px 30px; background: var(--accent-color); color: white; border: none; border-radius: 20px; font-size: 16px; cursor: pointer; display: none; }

        /* ì—…ë¡œë“œ ë²„íŠ¼ & ì§„í–‰ë¥ ë°” */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 90; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        #progressModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .progress-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px; }
        .progress-bar { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s; }

        /* [ìˆ˜ì •ë¨] ë¼ì´íŠ¸ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (iframe ëŒ€ì‘) */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        /* iframeì„ ë‹´ì„ ì»¨í…Œì´ë„ˆ */
        .lb-content { position: relative; width: 90%; height: 80%; display: flex; justify-content: center; align-items: center; }
        /* êµ¬ê¸€ ë·°ì–´ iframe ìŠ¤íƒ€ì¼ */
        .lb-content iframe { width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: #000; }
        
        .lb-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; z-index: 1001; }
        .lb-nav { position: absolute; top: 50%; transform: translateY(-50%); color: white; font-size: 40px; cursor: pointer; padding: 20px; user-select: none; z-index: 1001; }
        .lb-prev { left: 10px; } .lb-next { right: 10px; }
        .lb-toolbar { margin-top: 20px; display: flex; gap: 20px; }
        .lb-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid white; background: transparent; color: white; cursor: pointer; font-size: 14px; text-decoration: none; }
        .lb-btn.delete { border-color: #ff4444; color: #ff4444; }
        .lb-btn.delete:hover { background: #ff4444; color: white; }
        .lb-btn:hover { background: white; color: black; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <h1>Archive</h1>
        <div class="controls">
            <button class="btn-icon" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ">ğŸŒ™</button>
            <button class="btn-icon" onclick="location.reload()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        </div>
    </header>
    <div class="search-box"><input type="text" id="searchInput" placeholder="íŒŒì¼ ì´ë¦„ ê²€ìƒ‰..." onkeyup="filterImages()"></div>

    <div class="gallery" id="gallery"></div>
    <button id="loadMoreBtn" onclick="loadMore()">ë” ë³´ê¸° (+24)</button>

    <label class="fab">+<input type="file" id="fileInput" accept="image/*,video/*" style="display: none;"></label>
    <div id="progressModal"><div class="progress-box"><h3 style="margin:0 0 10px 0; color:#333">ì—…ë¡œë“œ ì¤‘...</h3><div id="progressText">0%</div><div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div></div></div>

    <div class="lightbox" id="lightbox">
        <div class="lb-close" onclick="closeLightbox()">&times;</div>
        <div class="lb-nav lb-prev" onclick="changeSlide(-1)">&#10094;</div>
        <div class="lb-nav lb-next" onclick="changeSlide(1)">&#10095;</div>
        
        <div class="lb-content" id="lbContent">
            </div>

        <div class="lb-toolbar">
            <button class="lb-btn delete" onclick="deleteCurrent()">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ [í•„ìˆ˜] ë°°í¬ëœ ìƒˆ URL ë„£ê¸° â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnkQ6Fh0JaM94AmS_HLQfD9O5wB2AHTMW17YF0a9p86RLu4G5kmEOOU5TodJfIqNb-/exec";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let allFiles = [], displayedCount = 0, currentIndex = -1;
        const batchSize = 24, gallery = document.getElementById('gallery'), loadMoreBtn = document.getElementById('loadMoreBtn');

        window.onload = async function() {
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
            try { const res = await fetch(SCRIPT_URL); allFiles = await res.json(); loadMore(); } catch (err) { alert("ë¡œë”© ì‹¤íŒ¨. ì£¼ì†Œ í™•ì¸ í•„ìš”."); }
        };

        function loadMore() {
            const nextBatch = allFiles.slice(displayedCount, displayedCount + batchSize);
            if (nextBatch.length === 0) { loadMoreBtn.style.display = 'none'; return; }
            nextBatch.forEach((file, index) => {
                const div = document.createElement('div'); div.className = 'item';
                div.onclick = () => openLightbox(displayedCount + index);
                const badge = file.mimeType.includes('video') ? '<div class="video-badge">VIDEO</div>' : '';
                div.innerHTML = `<img src="${file.url}" loading="lazy">${badge}`;
                gallery.appendChild(div);
            });
            displayedCount += nextBatch.length;
            loadMoreBtn.style.display = displayedCount < allFiles.length ? 'block' : 'none';
        }

        function filterImages() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.item').forEach((item, index) => {
                if (index < allFiles.length) item.classList.toggle('hidden', !allFiles[index].name.toLowerCase().includes(query));
            });
            loadMoreBtn.style.display = query ? 'none' : 'block';
        }

        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }

        document.getElementById('fileInput').addEventListener('change', function(e) { handleUpload(e.target.files[0]); });
        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) if (item.kind === 'file') handleUpload(item.getAsFile());
        });

        function handleUpload(file) {
            if (!file) return;
            const modal = document.getElementById('progressModal'), bar = document.getElementById('progressFill'), text = document.getElementById('progressText');
            modal.style.display = 'flex'; let progress = 0;
            const interval = setInterval(() => { if (progress < 90) { progress += Math.random()*10; if(progress>90) progress=90; bar.style.width = progress+'%'; text.innerText = Math.floor(progress)+'%'; }}, 300);
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = function() {
                fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ filename: file.name, mimeType: file.type, file: reader.result.split(',')[1] }) })
                .then(() => { clearInterval(interval); bar.style.width='100%'; text.innerText='ì™„ë£Œ!'; setTimeout(() => location.reload(), 800); })
                .catch(() => { alert("ì—…ë¡œë“œ ì‹¤íŒ¨"); modal.style.display = 'none'; });
            };
        }

        // ================= [ìˆ˜ì •ë¨] ë¼ì´íŠ¸ë°•ìŠ¤ ë¡œì§ =================
        function openLightbox(index) { currentIndex = index; updateLightboxContent(); document.getElementById('lightbox').style.display = 'flex'; }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; document.getElementById('lbContent').innerHTML = ''; }
        function changeSlide(d) { currentIndex += d; if(currentIndex < 0) currentIndex = allFiles.length-1; if(currentIndex >= allFiles.length) currentIndex = 0; updateLightboxContent(); }
        
        function updateLightboxContent() {
            const file = allFiles[currentIndex];
            // [í•µì‹¬] img íƒœê·¸ ëŒ€ì‹  êµ¬ê¸€ ë¯¸ë¦¬ë³´ê¸° iframe ì‚¬ìš©
            document.getElementById('lbContent').innerHTML = `
                <iframe src="${file.originUrl}" allow="autoplay" allowfullscreen></iframe>
            `;
        }

        async function deleteCurrent() {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const btn = document.querySelector('.lb-btn.delete'); btn.innerText = "ì‚­ì œ ì¤‘...";
            try { await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "delete", fileId: allFiles[currentIndex].id }) }); alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
            catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨"); btn.innerText = "ì‚­ì œí•˜ê¸°"; }
        }
        document.addEventListener('keydown', function(e) { if(document.getElementById('lightbox').style.display==='flex'){ if(e.key==='ArrowLeft') changeSlide(-1); if(e.key==='ArrowRight') changeSlide(1); if(e.key==='Escape') closeLightbox(); }});
    </script>
</body>
</html>
