<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Archive</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        :root { --bg: #f4f4f9; --card: #fff; --text: #333; --accent: #007AFF; }
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #4dabf7; }
        body { margin: 0; padding: 20px; background: var(--bg); color: var(--text); font-family: sans-serif; transition: 0.3s; }
        
        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; max-width: 1000px; margin: 0 auto 20px; }
        .btn-icon { background: var(--card); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--text); }
        
        /* ê²€ìƒ‰ */
        .search-box { max-width: 1000px; margin: 0 auto 20px; }
        #searchInput { width: 100%; padding: 12px; border-radius: 25px; border: none; background: var(--card); color: var(--text); box-sizing: border-box; outline: none; }

        /* ê°¤ëŸ¬ë¦¬ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-width: 1000px; margin: 0 auto; }
        .item { position: relative; border-radius: 12px; overflow: hidden; background: var(--card); aspect-ratio: 1/1; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .item:active { transform: scale(0.98); } /* í´ë¦­ê° ì¶”ê°€ */
        .item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; /* ì´ë¯¸ì§€ í´ë¦­ ë°©í•´ ê¸ˆì§€ */ }
        .video-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        
        /* ë”ë³´ê¸° ë²„íŠ¼ */
        #loadMoreBtn { display: block; margin: 30px auto; padding: 10px 30px; background: var(--accent); color: white; border: none; border-radius: 20px; cursor: pointer; display: none; }

        /* ë¼ì´íŠ¸ë°•ìŠ¤ (ë·°ì–´) */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .lb-content { position: relative; width: 90%; height: 80%; display: flex; justify-content: center; align-items: center; }
        
        /* ì´ë¯¸ì§€ì™€ ë¹„ë””ì˜¤ ìŠ¤íƒ€ì¼ êµ¬ë¶„ */
        .lb-content img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; }
        .lb-content iframe { width: 100%; height: 100%; border: none; border-radius: 4px; background: #000; }
        
        /* ì»¨íŠ¸ë¡¤ */
        .lb-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; padding: 10px; z-index: 2001; }
        .lb-nav { position: absolute; top: 50%; transform: translateY(-50%); color: white; font-size: 40px; cursor: pointer; padding: 20px; z-index: 2001; user-select: none; }
        .lb-prev { left: 0; } .lb-next { right: 0; }
        .lb-toolbar { margin-top: 20px; }
        .lb-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid #ff4444; background: transparent; color: #ff4444; cursor: pointer; }
        
        /* ì—…ë¡œë“œ & ë¡œë”© */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; }
        #progressModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .progress-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 200px; }
    </style>
</head>
<body>

    <header>
        <h1 style="margin:0">Archive</h1>
        <div>
            <button class="btn-icon" onclick="toggleDarkMode()">ğŸŒ™</button>
            <button class="btn-icon" onclick="location.reload()">ğŸ”„</button>
        </div>
    </header>

    <div class="search-box"><input type="text" id="searchInput" placeholder="ê²€ìƒ‰..." onkeyup="filterImages()"></div>

    <div class="gallery" id="gallery"></div>
    <button id="loadMoreBtn" onclick="loadMore()">ë” ë³´ê¸°</button>

    <label class="fab">+<input type="file" id="fileInput" accept="image/*,video/*" style="display: none;"></label>
    
    <div id="progressModal">
        <div class="progress-box">
            <h3>ì—…ë¡œë“œ ì¤‘...</h3>
            <div id="progressText">0%</div>
        </div>
    </div>

    <div class="lightbox" id="lightbox">
        <div class="lb-close" onclick="closeLightbox()">&times;</div>
        <div class="lb-nav lb-prev" onclick="changeSlide(-1)">&#10094;</div>
        <div class="lb-nav lb-next" onclick="changeSlide(1)">&#10095;</div>
        <div class="lb-content" id="lbContent"></div>
        <div class="lb-toolbar"><button class="lb-btn" onclick="deleteCurrent()">ì‚­ì œí•˜ê¸°</button></div>
    </div>

    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— ìƒˆ ë°°í¬ URLì„ ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwydf46GiNEU_EAv1xFiIcxypy2L76cy2aQpppv_EtbEqR-XYDQYhVfISBlpgJsKQLO/exec";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let allFiles = [];
        let displayedCount = 0;
        let currentIndex = 0;
        const batchSize = 24;

        // ì´ˆê¸°í™”
        window.onload = async () => {
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');
            try {
                const res = await fetch(SCRIPT_URL);
                allFiles = await res.json();
                loadMore();
            } catch (err) { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨. ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”."); }
        };

        // ë” ë³´ê¸° & ê°¤ëŸ¬ë¦¬ ìƒì„±
        function loadMore() {
            const nextBatch = allFiles.slice(displayedCount, displayedCount + batchSize);
            if (nextBatch.length === 0) { document.getElementById('loadMoreBtn').style.display = 'none'; return; }
            
            const gallery = document.getElementById('gallery');
            
            nextBatch.forEach((file, i) => {
                const globalIndex = displayedCount + i; // ì „ì²´ ë¦¬ìŠ¤íŠ¸ ê¸°ì¤€ ì¸ë±ìŠ¤
                const div = document.createElement('div');
                div.className = 'item';
                
                // [ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”© ë°©ì‹ì„ ì•ˆì „í•˜ê²Œ ë³€ê²½
                div.onclick = function() { openLightbox(globalIndex); };
                
                const badge = file.mimeType.includes('video') ? '<div class="video-badge">VIDEO</div>' : '';
                div.innerHTML = `<img src="${file.thumbnail}" loading="lazy">${badge}`;
                gallery.appendChild(div);
            });

            displayedCount += nextBatch.length;
            document.getElementById('loadMoreBtn').style.display = displayedCount < allFiles.length ? 'block' : 'none';
        }

        // ë¼ì´íŠ¸ë°•ìŠ¤ ì—´ê¸° (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹)
        function openLightbox(index) {
            currentIndex = index;
            const file = allFiles[index];
            const container = document.getElementById('lbContent');
            
            container.innerHTML = ''; // ì´ˆê¸°í™”

            if (file.mimeType.includes('video')) {
                // ë™ì˜ìƒì€ iframe í”Œë ˆì´ì–´
                container.innerHTML = `<iframe src="${file.videoPlayer}" allow="autoplay" allowfullscreen></iframe>`;
            } else {
                // ì‚¬ì§„ì€ ê³ í™”ì§ˆ ì´ë¯¸ì§€ íƒœê·¸ (w1920)
                container.innerHTML = `<img src="${file.largeImage}">`;
            }

            document.getElementById('lightbox').style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            document.getElementById('lbContent').innerHTML = ''; // ì˜ìƒ ì†Œë¦¬ ë„ê¸° ìœ„í•¨
        }

        function changeSlide(d) {
            currentIndex += d;
            if (currentIndex < 0) currentIndex = allFiles.length - 1;
            if (currentIndex >= allFiles.length) currentIndex = 0;
            openLightbox(currentIndex);
        }

        // ì‚­ì œ ê¸°ëŠ¥
        async function deleteCurrent() {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const btn = document.querySelector('.lb-btn');
            btn.innerText = "ì‚­ì œ ì¤‘...";
            try {
                await fetch(SCRIPT_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ action: "delete", fileId: allFiles[currentIndex].id }) 
                });
                alert("ì‚­ì œ ì™„ë£Œ"); location.reload();
            } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨"); btn.innerText = "ì‚­ì œí•˜ê¸°"; }
        }

        // ê¸°íƒ€ ê¸°ëŠ¥ (ë‹¤í¬ëª¨ë“œ, ê²€ìƒ‰, ì—…ë¡œë“œ)
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }
        
        function filterImages() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.item').forEach((item, i) => {
                if(i < allFiles.length) item.style.display = allFiles[i].name.toLowerCase().includes(q) ? 'block' : 'none';
            });
        }

        document.getElementById('fileInput').addEventListener('change', (e) => handleUpload(e.target.files[0]));
        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) if (item.kind === 'file') handleUpload(item.getAsFile());
        });

        function handleUpload(file) {
            if(!file) return;
            const modal = document.getElementById('progressModal');
            modal.style.display = 'flex';
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ filename: file.name, mimeType: file.type, file: reader.result.split(',')[1] })
                }).then(() => { location.reload(); }).catch(() => { alert("ì‹¤íŒ¨"); modal.style.display = 'none'; });
            };
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('lightbox').style.display === 'flex') {
                if(e.key === 'ArrowLeft') changeSlide(-1);
                if(e.key === 'ArrowRight') changeSlide(1);
                if(e.key === 'Escape') closeLightbox();
            }
        });
    </script>
</body>
</html>
