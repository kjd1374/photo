<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Archive 2.0</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #007AFF;
        }
        /* ë‹¤í¬ ëª¨ë“œ ë³€ìˆ˜ */
        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #4dabf7;
        }

        body { margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, sans-serif; transition: background 0.3s, color 0.3s; }
        
        /* í—¤ë” ì˜ì—­ */
        header { display: flex; justify-content: space-between; align-items: center; max-width: 1000px; margin: 0 auto 20px; padding: 0 10px; }
        h1 { margin: 0; font-weight: 700; letter-spacing: -0.5px; }
        
        .controls { display: flex; gap: 10px; }
        .btn-icon { background: var(--card-bg); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; color: var(--text-color); transition: 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }

        /* ê²€ìƒ‰ì°½ */
        .search-box { max-width: 1000px; margin: 0 auto 20px; padding: 0 10px; }
        #searchInput { width: 100%; padding: 12px 20px; border-radius: 25px; border: none; background: var(--card-bg); color: var(--text-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); font-size: 16px; outline: none; box-sizing: border-box; }

        /* ê°¤ëŸ¬ë¦¬ ê·¸ë¦¬ë“œ */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .item {
            position: relative; border-radius: 12px; overflow: hidden;
            background: var(--card-bg); aspect-ratio: 1 / 1; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .item:hover { transform: translateY(-3px); }
        .item img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
        
        /* ë™ì˜ìƒ ì•„ì´ì½˜ */
        .video-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        /* ë”ë³´ê¸° ë²„íŠ¼ */
        #loadMoreBtn { display: block; margin: 30px auto; padding: 10px 30px; background: var(--accent-color); color: white; border: none; border-radius: 20px; font-size: 16px; cursor: pointer; display: none; }

        /* ì—…ë¡œë“œ ë²„íŠ¼ (í”Œë¡œíŒ…) */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background-color: var(--accent-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 32px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 90; transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* ë¼ì´íŠ¸ë°•ìŠ¤ (ìƒì„¸ë³´ê¸°) */
        .lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .lb-content { position: relative; max-width: 90%; max-height: 80%; }
        .lb-content img, .lb-content video { max-width: 100%; max-height: 80vh; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* ë¼ì´íŠ¸ë°•ìŠ¤ ì»¨íŠ¸ë¡¤ */
        .lb-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; z-index: 1001; }
        .lb-nav { position: absolute; top: 50%; transform: translateY(-50%); color: white; font-size: 40px; cursor: pointer; padding: 20px; user-select: none; z-index: 1001; }
        .lb-prev { left: 10px; }
        .lb-next { right: 10px; }
        
        /* ë¼ì´íŠ¸ë°•ìŠ¤ í•˜ë‹¨ íˆ´ë°” (ì‚­ì œ ë²„íŠ¼ ë“±) */
        .lb-toolbar { margin-top: 20px; display: flex; gap: 20px; }
        .lb-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid white; background: transparent; color: white; cursor: pointer; font-size: 14px; }
        .lb-btn.delete { border-color: #ff4444; color: #ff4444; }
        .lb-btn.delete:hover { background: #ff4444; color: white; }
        .lb-btn:hover { background: white; color: black; }

        /* ë¡œë”© ë° ì§„í–‰ë¥  ë°” */
        #progressModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            align-items: center; justify-content: center; z-index: 2000;
        }
        .progress-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px; }
        .progress-bar { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s; }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <h1>Archive</h1>
        <div class="controls">
            <button class="btn-icon" onclick="toggleDarkMode()" title="ë‹¤í¬ëª¨ë“œ">ğŸŒ™</button>
            <button class="btn-icon" onclick="location.reload()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        </div>
    </header>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="íŒŒì¼ ì´ë¦„ ê²€ìƒ‰..." onkeyup="filterImages()">
    </div>

    <div class="gallery" id="gallery"></div>
    <button id="loadMoreBtn" onclick="loadMore()">ë” ë³´ê¸° (+20)</button>

    <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
    <label class="fab">
        +
        <input type="file" id="fileInput" accept="image/*,video/*" style="display: none;">
    </label>

    <!-- ì§„í–‰ë¥  ëª¨ë‹¬ -->
    <div id="progressModal">
        <div class="progress-box">
            <h3 style="margin:0 0 10px 0; color:#333">ì—…ë¡œë“œ ì¤‘...</h3>
            <div id="progressText">0%</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- ë¼ì´íŠ¸ë°•ìŠ¤ (í¬ê²Œ ë³´ê¸°) -->
    <div class="lightbox" id="lightbox">
        <div class="lb-close" onclick="closeLightbox()">&times;</div>
        <div class="lb-nav lb-prev" onclick="changeSlide(-1)">&#10094;</div>
        <div class="lb-nav lb-next" onclick="changeSlide(1)">&#10095;</div>
        
        <div class="lb-content" id="lbContent">
            <!-- ì´ë¯¸ì§€ë‚˜ ë¹„ë””ì˜¤ê°€ ì—¬ê¸° ë“¤ì–´ê° -->
        </div>

        <div class="lb-toolbar">
            <button class="lb-btn" onclick="downloadCurrent()">ë‹¤ìš´ë¡œë“œ</button>
            <button class="lb-btn delete" onclick="deleteCurrent()">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ [í•„ìˆ˜] ë°°í¬ëœ ìƒˆ URL ë„£ê¸° â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMF3w-Okw-cWxyhwMMr6YcwtdDxmcP0GHCCYcW3dUfxzVek-ceglpILD4U4HLJfagG/exec";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let allFiles = [];      // ì „ì²´ íŒŒì¼ ë¦¬ìŠ¤íŠ¸
        let displayedCount = 0; // í˜„ì¬ ë³´ì—¬ì£¼ëŠ” ê°œìˆ˜
        const batchSize = 24;   // í•œ ë²ˆì— ë³´ì—¬ì¤„ ê°œìˆ˜
        let currentIndex = -1;  // ë¼ì´íŠ¸ë°•ìŠ¤ í˜„ì¬ ë³´ê³  ìˆëŠ” íŒŒì¼ ì¸ë±ìŠ¤

        const gallery = document.getElementById('gallery');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        // 1. ì‹œì‘ ì‹œ ë°ì´í„° ë¡œë“œ
        window.onload = async function() {
            // ë‹¤í¬ëª¨ë“œ ìƒíƒœ ë³µêµ¬
            if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

            try {
                const res = await fetch(SCRIPT_URL);
                allFiles = await res.json();
                loadMore(); // ì²« í˜ì´ì§€ ë¡œë“œ
            } catch (err) {
                alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨. URLì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        };

        // 2. ë” ë³´ê¸° ê¸°ëŠ¥ (Pagination)
        function loadMore() {
            const nextBatch = allFiles.slice(displayedCount, displayedCount + batchSize);
            if (nextBatch.length === 0) {
                loadMoreBtn.style.display = 'none';
                return;
            }

            nextBatch.forEach((file, index) => {
                const globalIndex = displayedCount + index;
                const div = document.createElement('div');
                div.className = 'item';
                div.onclick = () => openLightbox(globalIndex);

                // ë¹„ë””ì˜¤ì¸ì§€ ì²´í¬
                const isVideo = file.mimeType.includes('video');
                const badge = isVideo ? '<div class="video-badge">VIDEO</div>' : '';

                div.innerHTML = `
                    <img src="${file.url}" loading="lazy">
                    ${badge}
                `;
                gallery.appendChild(div);
            });

            displayedCount += nextBatch.length;
            
            // ë” ë³´ì—¬ì¤„ ê²Œ ë‚¨ì•˜ìœ¼ë©´ ë²„íŠ¼ í‘œì‹œ
            loadMoreBtn.style.display = displayedCount < allFiles.length ? 'block' : 'none';
        }

        // 3. ê²€ìƒ‰ ê¸°ëŠ¥
        function filterImages() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.item');
            let matchCount = 0;

            items.forEach((item, index) => {
                // ì‹¤ì œ ë°ì´í„°ì™€ ë§¤ì¹­ (HTML ìˆœì„œì™€ allFiles ìˆœì„œê°€ ê°™ìŒì„ ì´ìš©)
                // ì£¼ì˜: ë”ë³´ê¸°ë¡œ ë¡œë“œëœ ê²ƒë§Œ ê²€ìƒ‰ë¨
                if (index < allFiles.length) {
                    const fileName = allFiles[index].name.toLowerCase();
                    if (fileName.includes(query)) {
                        item.classList.remove('hidden');
                        matchCount++;
                    } else {
                        item.classList.add('hidden');
                    }
                }
            });
            
            // ê²€ìƒ‰ ì¤‘ì¼ ë• ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¹€
            loadMoreBtn.style.display = query ? 'none' : 'block';
        }

        // 4. ë‹¤í¬ëª¨ë“œ í† ê¸€
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // 5. ì—…ë¡œë“œ (ê°€ì§œ ì§„í–‰ë¥  ë°” êµ¬í˜„)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const modal = document.getElementById('progressModal');
            const bar = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            modal.style.display = 'flex';
            let progress = 0;
            
            // 0~90%ê¹Œì§€ ê°€ì§œ ì• ë‹ˆë©”ì´ì…˜
            const interval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;
                    bar.style.width = progress + '%';
                    text.innerText = Math.floor(progress) + '%';
                }
            }, 300);

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                const rawBase64 = reader.result.split(',')[1];
                const payload = JSON.stringify({ filename: file.name, mimeType: file.type, file: rawBase64 });

                fetch(SCRIPT_URL, { method: "POST", body: payload })
                .then(res => res.text())
                .then(text => {
                    clearInterval(interval);
                    bar.style.width = '100%';
                    text.innerText = '100% ì™„ë£Œ!';
                    setTimeout(() => location.reload(), 800);
                })
                .catch(err => {
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
                    modal.style.display = 'none';
                });
            };
        });

        // 6. ë¶™ì—¬ë„£ê¸° ì§€ì›
        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.kind === 'file') {
                    document.getElementById('fileInput').files = e.clipboardData.files; // fileInputì— í• ë‹¹ ì‹œë„ (ë¸Œë¼ìš°ì € ì œí•œ ìˆì„ ìˆ˜ ìˆìŒ)
                    // ì§ì ‘ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°ëŠ” ì–´ë ¤ìš°ë‹ˆ ë¡œì§ ì¬ì‚¬ìš© ê¶Œì¥í•˜ì§€ë§Œ, 
                    // ê°„ë‹¨íˆ fileInput change ì´ë²¤íŠ¸ë¥¼ ëª¨ë°©í•´ì„œ í˜¸ì¶œ
                    // (ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ìƒëµí•˜ê³  íŒŒì¼ ì„ íƒ ê¶Œì¥)
                    alert("ë¶™ì—¬ë„£ì€ íŒŒì¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. + ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ íƒí•´ì£¼ì„¸ìš”. (ë³´ì•ˆìƒ ìë™ ì—…ë¡œë“œ ì œí•œ)");
                }
            }
        });

        // ================= ë¼ì´íŠ¸ë°•ìŠ¤ ë¡œì§ =================

        function openLightbox(index) {
            currentIndex = index;
            updateLightboxContent();
            document.getElementById('lightbox').style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            // ë¹„ë””ì˜¤ ë©ˆì¶¤ ì²˜ë¦¬
            const video = document.querySelector('.lb-content video');
            if (video) video.pause();
        }

        function changeSlide(direction) {
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = allFiles.length - 1;
            if (currentIndex >= allFiles.length) currentIndex = 0; // ìˆœí™˜
            updateLightboxContent();
        }

        function updateLightboxContent() {
            const file = allFiles[currentIndex];
            const container = document.getElementById('lbContent');
            container.innerHTML = ''; // ë¹„ìš°ê¸°

            if (file.mimeType.includes('video')) {
                container.innerHTML = `<video src="${file.originUrl}" controls autoplay style="max-width:100%; max-height:80vh"></video>`;
            } else {
                container.innerHTML = `<img src="${file.originUrl}">`;
            }
        }

        function downloadCurrent() {
            const file = allFiles[currentIndex];
            window.open(file.originUrl, '_blank');
        }

        async function deleteCurrent() {
            if (!confirm("ì •ë§ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (êµ¬ê¸€ ë“œë¼ì´ë¸Œ íœ´ì§€í†µìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤)")) return;
            
            const file = allFiles[currentIndex];
            const btn = document.querySelector('.lb-btn.delete');
            btn.innerText = "ì‚­ì œ ì¤‘...";
            
            try {
                const payload = JSON.stringify({ action: "delete", fileId: file.id });
                await fetch(SCRIPT_URL, { method: "POST", body: payload });
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } catch (e) {
                alert("ì‚­ì œ ì‹¤íŒ¨");
                btn.innerText = "ì‚­ì œí•˜ê¸°";
            }
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ì¢Œìš° í™”ì‚´í‘œ, ESC)
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('lightbox').style.display === 'flex') {
                if (e.key === 'ArrowLeft') changeSlide(-1);
                if (e.key === 'ArrowRight') changeSlide(1);
                if (e.key === 'Escape') closeLightbox();
            }
        });

    </script>
</body>
</html>
